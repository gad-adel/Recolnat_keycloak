{"version":3,"file":"MappingDetails-4JZmq9gl.js","sources":["../../src/client-scopes/details/MappingDetails.tsx"],"sourcesContent":["import type ProtocolMapperRepresentation from \"@keycloak/keycloak-admin-client/lib/defs/protocolMapperRepresentation\";\nimport type { ProtocolMapperTypeRepresentation } from \"@keycloak/keycloak-admin-client/lib/defs/serverInfoRepesentation\";\nimport {\n  ActionGroup,\n  AlertVariant,\n  Button,\n  ButtonVariant,\n  DropdownItem,\n  FormGroup,\n  PageSection,\n  ValidatedOptions,\n} from \"@patternfly/react-core\";\nimport { useState } from \"react\";\nimport { FormProvider, useForm } from \"react-hook-form\";\nimport { useTranslation } from \"react-i18next\";\nimport { Link, useMatch, useNavigate } from \"react-router-dom\";\nimport { HelpItem } from \"ui-shared\";\n\nimport { adminClient } from \"../../admin-client\";\nimport { toClient } from \"../../clients/routes/Client\";\nimport { useAlerts } from \"../../components/alert/Alerts\";\nimport { useConfirmDialog } from \"../../components/confirm-dialog/ConfirmDialog\";\nimport { DynamicComponents } from \"../../components/dynamic/DynamicComponents\";\nimport { FormAccess } from \"../../components/form/FormAccess\";\nimport { KeycloakTextInput } from \"../../components/keycloak-text-input/KeycloakTextInput\";\nimport { ViewHeader } from \"../../components/view-header/ViewHeader\";\nimport { useRealm } from \"../../context/realm-context/RealmContext\";\nimport { useServerInfo } from \"../../context/server-info/ServerInfoProvider\";\nimport { convertFormValuesToObject, convertToFormValues } from \"../../util\";\nimport { useFetch } from \"../../utils/useFetch\";\nimport { useParams } from \"../../utils/useParams\";\nimport { toClientScope } from \"../routes/ClientScope\";\nimport { MapperParams, MapperRoute } from \"../routes/Mapper\";\n\nexport default function MappingDetails() {\n  const { t } = useTranslation();\n  const { addAlert, addError } = useAlerts();\n\n  const { id, mapperId } = useParams<MapperParams>();\n  const form = useForm();\n  const {\n    register,\n    setValue,\n    formState: { errors },\n    handleSubmit,\n  } = form;\n  const [mapping, setMapping] = useState<ProtocolMapperTypeRepresentation>();\n  const [config, setConfig] = useState<{\n    protocol?: string;\n    protocolMapper?: string;\n  }>();\n\n  const navigate = useNavigate();\n  const { realm } = useRealm();\n  const serverInfo = useServerInfo();\n  const isGuid = /^[{]?[0-9a-fA-F]{8}-([0-9a-fA-F]{4}-){3}[0-9a-fA-F]{12}[}]?$/;\n  const isUpdating = !!mapperId.match(isGuid);\n\n  const isOnClientScope = !!useMatch(MapperRoute.path);\n  const toDetails = () =>\n    isOnClientScope\n      ? toClientScope({ realm, id, tab: \"mappers\" })\n      : toClient({ realm, clientId: id, tab: \"mappers\" });\n\n  useFetch(\n    async () => {\n      let data: ProtocolMapperRepresentation | undefined;\n      if (isUpdating) {\n        if (isOnClientScope) {\n          data = await adminClient.clientScopes.findProtocolMapper({\n            id,\n            mapperId,\n          });\n        } else {\n          data = await adminClient.clients.findProtocolMapperById({\n            id,\n            mapperId,\n          });\n        }\n        if (!data) {\n          throw new Error(t(\"notFound\"));\n        }\n\n        const mapperTypes = serverInfo.protocolMapperTypes![data!.protocol!];\n        const mapping = mapperTypes.find(\n          (type) => type.id === data!.protocolMapper,\n        );\n\n        return {\n          config: {\n            protocol: data.protocol,\n            protocolMapper: data.protocolMapper,\n          },\n          mapping,\n          data,\n        };\n      } else {\n        const model = isOnClientScope\n          ? await adminClient.clientScopes.findOne({ id })\n          : await adminClient.clients.findOne({ id });\n        if (!model) {\n          throw new Error(t(\"notFound\"));\n        }\n        const protocolMappers =\n          serverInfo.protocolMapperTypes![model.protocol!];\n        const mapping = protocolMappers.find(\n          (mapper) => mapper.id === mapperId,\n        );\n        if (!mapping) {\n          throw new Error(t(\"notFound\"));\n        }\n        return {\n          mapping,\n          config: {\n            protocol: model.protocol,\n            protocolMapper: mapperId,\n          },\n        };\n      }\n    },\n    ({ config, mapping, data }) => {\n      setConfig(config);\n      setMapping(mapping);\n      if (data) {\n        convertToFormValues(data, setValue);\n      }\n    },\n    [],\n  );\n\n  const [toggleDeleteDialog, DeleteConfirm] = useConfirmDialog({\n    titleKey: \"deleteMappingTitle\",\n    messageKey: \"deleteMappingConfirm\",\n    continueButtonLabel: \"delete\",\n    continueButtonVariant: ButtonVariant.danger,\n    onConfirm: async () => {\n      try {\n        if (isOnClientScope) {\n          await adminClient.clientScopes.delProtocolMapper({\n            id,\n            mapperId,\n          });\n        } else {\n          await adminClient.clients.delProtocolMapper({\n            id,\n            mapperId,\n          });\n        }\n        addAlert(t(\"mappingDeletedSuccess\"), AlertVariant.success);\n        navigate(toDetails());\n      } catch (error) {\n        addError(\"mappingDeletedError\", error);\n      }\n    },\n  });\n\n  const save = async (formMapping: ProtocolMapperRepresentation) => {\n    const key = isUpdating ? \"Updated\" : \"Created\";\n    try {\n      const mapping = { ...config, ...convertFormValuesToObject(formMapping) };\n      if (isUpdating) {\n        isOnClientScope\n          ? await adminClient.clientScopes.updateProtocolMapper(\n              { id, mapperId },\n              { id: mapperId, ...mapping },\n            )\n          : await adminClient.clients.updateProtocolMapper(\n              { id, mapperId },\n              { id: mapperId, ...mapping },\n            );\n      } else {\n        isOnClientScope\n          ? await adminClient.clientScopes.addProtocolMapper({ id }, mapping)\n          : await adminClient.clients.addProtocolMapper({ id }, mapping);\n      }\n      addAlert(t(`mapping${key}Success`), AlertVariant.success);\n    } catch (error) {\n      addError(`mapping${key}Error`, error);\n    }\n  };\n\n  return (\n    <>\n      <DeleteConfirm />\n      <ViewHeader\n        titleKey={isUpdating ? mapping?.name! : t(\"addMapper\")}\n        subKey={isUpdating ? mapperId : \"addMapperExplain\"}\n        dropdownItems={\n          isUpdating\n            ? [\n                <DropdownItem\n                  key=\"delete\"\n                  value=\"delete\"\n                  onClick={toggleDeleteDialog}\n                >\n                  {t(\"delete\")}\n                </DropdownItem>,\n              ]\n            : undefined\n        }\n      />\n      <PageSection variant=\"light\">\n        <FormAccess\n          isHorizontal\n          onSubmit={handleSubmit(save)}\n          role=\"manage-clients\"\n        >\n          <FormGroup label={t(\"mapperType\")} fieldId=\"mapperType\">\n            <KeycloakTextInput\n              type=\"text\"\n              id=\"mapperType\"\n              name=\"mapperType\"\n              isReadOnly\n              value={mapping?.name}\n            />\n          </FormGroup>\n          <FormGroup\n            label={t(\"name\")}\n            labelIcon={\n              <HelpItem helpText={t(\"mapperNameHelp\")} fieldLabelId=\"name\" />\n            }\n            fieldId=\"name\"\n            isRequired\n            validated={\n              errors.name ? ValidatedOptions.error : ValidatedOptions.default\n            }\n            helperTextInvalid={t(\"required\")}\n          >\n            <KeycloakTextInput\n              id=\"name\"\n              isReadOnly={isUpdating}\n              validated={\n                errors.name ? ValidatedOptions.error : ValidatedOptions.default\n              }\n              {...register(\"name\", { required: true })}\n            />\n          </FormGroup>\n          <FormProvider {...form}>\n            <DynamicComponents\n              properties={mapping?.properties || []}\n              isNew={!isUpdating}\n            />\n          </FormProvider>\n          <ActionGroup>\n            <Button variant=\"primary\" type=\"submit\">\n              {t(\"save\")}\n            </Button>\n            <Button\n              variant=\"link\"\n              component={(props) => <Link {...props} to={toDetails()} />}\n            >\n              {t(\"cancel\")}\n            </Button>\n          </ActionGroup>\n        </FormAccess>\n      </PageSection>\n    </>\n  );\n}\n"],"names":["MappingDetails","useTranslation","addAlert","addError","useAlerts","id","mapperId","useParams","form","useForm","register","setValue","errors","handleSubmit","mapping","setMapping","useState","config","setConfig","navigate","useNavigate","realm","useRealm","serverInfo","useServerInfo","isGuid","isUpdating","isOnClientScope","useMatch","MapperRoute","toDetails","toClientScope","toClient","useFetch","data","adminClient","type","model","mapper","convertToFormValues","toggleDeleteDialog","DeleteConfirm","useConfirmDialog","ButtonVariant","AlertVariant","error","save","formMapping","key","convertFormValuesToObject","jsxs","Fragment","jsx","ViewHeader","DropdownItem","PageSection","FormAccess","FormGroup","KeycloakTextInput","HelpItem","ValidatedOptions","FormProvider","DynamicComponents","ActionGroup","Button","props","Link"],"mappings":"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"}