import{jsx as e,jsxs as O,Fragment as K}from"react/jsx-runtime";import{a as k}from"./policyRepresentation-ct1daQhu.js";import{useState as T,useRef as G}from"react";import{u as U,a as $,r as z,C as _,S as J,b as V,c as Q,j as d,g as W,d as Z,f as X,m as H,A as N,b7 as B,Z as Y,O as ee,aF as ie,K as se,P as re,h as te,F as p,i as m,Q as oe,R as ae,B as j,L as le,aJ as ne}from"./index-sihFV1NS.js";import{u as ce}from"./ConfirmDialog-WMVurgkl.js";import{F as de}from"./FormAccess-EK-4wbwg.js";import{K as pe}from"./KeycloakTextArea-NBwG1p2x.js";import{K as E}from"./KeycloakTextInput--S1SG2UN.js";import{V as me}from"./ViewHeader-xo54NRb6.js";import{u as ue}from"./useParams-OD1jI_R2.js";import{R as M}from"./NewPolicyDialog-th1Dwl3Y.js";import{A as fe}from"./Form-bfj-xQZn.js";import"react-dom";import"./Modal-uOAPm2rX.js";import"./copy-icon-WaWzxYgU.js";import"./ToolbarContent-46I9Yg7h.js";import"./useLocaleSort-K-jL4v2R.js";import"./Td-uwYquKT4.js";import"./TableToolbar-vuixsfwd.js";import"./grip-vertical-icon-accuSWkz.js";import"./useToggle-mZS4AEtR.js";import"./ClientScopeTypes-Hwl8E8GJ.js";import"./PaginatingTableToolbar--Dt3wwL6.js";import"./EmptyStateBody-jnnI7hpP.js";import"./EmptyStateSecondaryActions-G5doWCZ5.js";import"./KeycloakDataTable-Q3kZYP9q.js";import"./_baseRest-lI6NnEVt.js";import"./utils-9X4NJJvK.js";import"./filter-icon-0B3gA_nj.js";import"./GroupPickerDialog-gC2-xBPw.js";import"./DataListItemRow-te2VcAoi.js";import"./data-list-CDN1kyj9.js";import"./CodeEditor-7uqvO0EK.js";import"./AddRoleMappingModal-uxjjMt5W.js";import"./resource-BRtaBrSc.js";import"./DatePicker-zM1UwT7F.js";import"./MenuList-82IaVNxu.js";import"./Flex-W2FoLD7u.js";import"./FlexItem-Mxf6oLng.js";import"./NumberInput-QtFengwl.js";import"./minus-icon-3MARcJXf.js";import"./plus-icon-zbmNbCLY.js";const he=({clientId:i,resourceId:u,preSelected:f})=>{const{t:b}=U(),{control:D,getValues:c,setValue:w,formState:{errors:x}}=$(),[o,S]=T([]),[t,a]=T([]),[h,g]=T(""),[P,I]=T(!1),C=G(!0),A=c("scopes"),v=l=>l.map(n=>e(Q,{value:n,children:n.name},n.id));return z(async()=>u?(u&&!C.current&&w("scopes",[]),C.current=!1,d.clients.listScopesByResource({id:i,resourceName:u})):d.clients.listAllScopes(Object.assign({id:i,deep:!1},h===""?null:{name:h})),l=>{S(l),h||a(l.filter(n=>A?.includes(n.id)))},[u,h]),e(_,{name:"scopes",defaultValue:f?[f]:[],control:D,rules:{validate:l=>l.length>0},render:({field:l})=>e(J,{toggleId:"scopes",variant:V.typeaheadMulti,onToggle:I,onFilter:(n,y)=>(g(y),v(o)),onClear:()=>{l.onChange([]),g("")},selections:t.map(n=>n.name),onSelect:(n,y)=>{const R=typeof y=="string"?t.find(s=>s.name===y):y,r=t.find(s=>s.id===R.id)?t.filter(s=>s.id!==R.id):[...t,R];l.onChange(r.map(s=>s.id)),a(r),g("")},isOpen:P,"aria-labelledby":b("scopes"),validated:x.scopes?"error":"default",isDisabled:!!f,typeAheadAriaLabel:b("scopes"),children:v(o)})})};function ti(){const{t:i}=U(),u=W({mode:"onChange"}),{register:f,control:b,reset:D,formState:{errors:c},handleSubmit:w}=u,x=Z(),{id:o,realm:S,permissionType:t,permissionId:a,selectedId:h}=ue(),{addAlert:g,addError:P}=X(),[I,C]=T(),[A,v]=T(!1);z(async()=>{if(!a)return{};const[r,s,L,q]=await Promise.all([d.clients.findOnePermission({id:o,type:t,permissionId:a}),d.clients.getAssociatedResources({id:o,permissionId:a}),d.clients.getAssociatedPolicies({id:o,permissionId:a}),d.clients.getAssociatedScopes({id:o,permissionId:a})]);if(!r)throw new Error(i("notFound"));return{permission:r,resources:s.map(F=>F._id),policies:L.map(F=>F.id),scopes:q.map(F=>F.id)}},({permission:r,resources:s,policies:L,scopes:q})=>{D({...r,resources:s,policies:L,scopes:q}),r&&"resourceType"in r&&v(!!r.resourceType),C({...r,resources:s,policies:L})},[]);const l=async r=>{try{if(a)await d.clients.updatePermission({id:o,type:t,permissionId:a},r);else{const s=await d.clients.createPermission({id:o,type:t},r);x(ne({realm:S,id:o,permissionType:t,permissionId:s.id}))}g(i((a?"update":"create")+"PermissionSuccess"),N.success)}catch(s){P("permissionSaveError",s)}},[n,y]=ce({titleKey:"deletePermission",messageKey:i("deletePermissionConfirm",{permission:I?.name}),continueButtonVariant:H.danger,continueButtonLabel:"confirm",onConfirm:async()=>{try{await d.clients.delPermission({id:o,type:t,permissionId:a}),g(i("permissionDeletedSuccess"),N.success),x(B({realm:S,clientId:o,tab:"permissions"}))}catch(r){P("permissionDeletedError",r)}}}),R=Y({control:b,name:"resources",defaultValue:[]});return I?O(K,{children:[e(y,{}),e(me,{titleKey:a?I.name:`create${ie(t)}BasedPermission`,dropdownItems:a?[e(se,{"data-testid":"delete-resource",onClick:()=>n(),children:i("delete")},"delete")]:void 0}),e(re,{variant:"light",children:e(de,{isHorizontal:!0,role:"view-clients",onSubmit:w(l),children:O(te,{...u,children:[e(p,{label:i("name"),isRequired:!0,helperTextInvalid:i("required"),validated:c.name?"error":"default",fieldId:"name",labelIcon:e(m,{helpText:i("permissionName"),fieldLabelId:"name"}),children:e(E,{id:"name",validated:c.name?"error":"default",...f("name",{required:!0})})}),e(p,{label:i("description"),fieldId:"description",labelIcon:e(m,{helpText:i("permissionDescription"),fieldLabelId:"description"}),validated:c.description?"error":"default",helperTextInvalid:c.description?.message,children:e(pe,{id:"description",validated:c.description?"error":"default",...f("description",{maxLength:{value:255,message:i("maxLength",{length:255})}})})}),e(p,{label:i("applyToResourceTypeFlag"),fieldId:"applyToResourceTypeFlag",labelIcon:e(m,{helpText:i("applyToResourceTypeFlagHelp"),fieldLabelId:"applyToResourceTypeFlag"}),children:e(oe,{id:"applyToResourceTypeFlag",name:"applyToResourceTypeFlag",label:i("on"),labelOff:i("off"),isChecked:A,onChange:v,"aria-label":i("applyToResourceTypeFlag")})}),A?e(p,{label:i("resourceType"),fieldId:"resourceType",labelIcon:e(m,{helpText:i("resourceTypeHelp"),fieldLabelId:"resourceType"}),isRequired:t==="scope",children:e(E,{id:"resourceType",...f("resourceType",{required:t==="scope"})})}):e(p,{label:i("resources"),fieldId:"resources",labelIcon:e(m,{helpText:i("permissionResourcesHelp"),fieldLabelId:"resources"}),helperTextInvalid:i("required"),validated:c.resources?"error":"default",isRequired:t!=="scope",children:e(M,{name:"resources",clientId:o,permissionId:a,preSelected:t==="scope"?void 0:h,variant:t==="scope"?V.typeahead:V.typeaheadMulti,isRequired:t!=="scope"})}),t==="scope"&&e(p,{label:i("authorizationScopes"),fieldId:"scopes",labelIcon:e(m,{helpText:i("permissionScopesHelp"),fieldLabelId:"scopesSelect"}),helperTextInvalid:i("required"),validated:c.scopes?"error":"default",isRequired:!0,children:e(he,{clientId:o,resourceId:R?.[0],preSelected:h})}),e(p,{label:i("policies"),fieldId:"policies",labelIcon:e(m,{helpText:i("permissionPoliciesHelp"),fieldLabelId:"policies"}),children:e(M,{name:"policies",clientId:o,permissionId:a})}),e(p,{label:i("decisionStrategy"),labelIcon:e(m,{helpText:i("permissionDecisionStrategyHelp"),fieldLabelId:"decisionStrategy"}),fieldId:"policyEnforcementMode",hasNoPaddingTop:!0,children:e(_,{name:"decisionStrategy","data-testid":"decisionStrategy",defaultValue:k.UNANIMOUS,control:b,render:({field:r})=>e(K,{children:Object.values(k).map(s=>e(ae,{id:s,"data-testid":s,isChecked:r.value===s,name:"decisionStrategies",onChange:()=>r.onChange(s),label:i(`decisionStrategies.${s}`),className:"pf-u-mb-md"},s))})})}),e(fe,{children:O("div",{className:"pf-u-mt-md",children:[e(j,{variant:H.primary,type:"submit","data-testid":"save",children:i("save")}),e(j,{variant:"link","data-testid":"cancel",component:r=>e(le,{...r,to:B({realm:S,clientId:o,tab:"permissions"})}),children:i("cancel")})]})})]})})})]}):e(ee,{})}export{ti as default};
//# sourceMappingURL=PermissionDetails-KngH58CA.js.map
