import{jsxs as T,jsx as e,Fragment as k}from"react/jsx-runtime";import*as X from"react";import{useEffect as be,useState as h}from"react";import{_ as oe,l as ie,bK as Y,o as ye,u as D,bL as H,e as ee,bh as q,bM as fe,bN as ae,L as z,f as Q,g as Ge,r as te,P as ce,bO as le,bm as we,G as ve,j as p,H as Me,A as B,aG as W,B as $,I as de,ai as ue,K as _,aj as V,O as Ce,bo as Se,b3 as Te,bP as Ke,d as Pe,bE as Ae,aq as Ie,ar as Re,bQ as ke,bR as De,E as Ne,bH as Ee,a8 as Fe}from"./index-sihFV1NS.js";import{P as Le}from"./PermissionTab-5VqfGSUL.js";import{V as Oe}from"./ViewHeader-xo54NRb6.js";import{u as xe,F as Ue}from"./useIsFeatureEnabled-qmmJPqO8.js";import{u as j}from"./useToggle-mZS4AEtR.js";import{A as Ve}from"./AttributeForm-St-qQE3r.js";import{R as Be}from"./AddRoleMappingModal-uxjjMt5W.js";import{L as se}from"./PaginatingTableToolbar--Dt3wwL6.js";import{K as re,o as $e}from"./KeycloakDataTable-Q3kZYP9q.js";import{D as me,a as Z,M as je,b as He,c as qe}from"./GroupPickerDialog-gC2-xBPw.js";import{b as E}from"./ToolbarContent-46I9Yg7h.js";import{S as ze}from"./TableToolbar-vuixsfwd.js";import{M as _e,a as Qe}from"./Modal-uOAPm2rX.js";import{T as We,a as x,b as U}from"./Tabs-wiayO8Tk.js";import"react-dom";import"./useLocaleSort-K-jL4v2R.js";import"./ConfirmDialog-WMVurgkl.js";import"./Trans-1cjg0ImV.js";import"./Form-bfj-xQZn.js";import"./Td-uwYquKT4.js";import"./grip-vertical-icon-accuSWkz.js";import"./FormAccess-EK-4wbwg.js";import"./copy-icon-WaWzxYgU.js";import"./KeyValueInput-CbiNnu-2.js";import"./KeycloakTextInput--S1SG2UN.js";import"./minus-icon-3MARcJXf.js";import"./ActionListItem-1jrwMZdM.js";import"./EmptyStateBody-jnnI7hpP.js";import"./resource-BRtaBrSc.js";import"./filter-icon-0B3gA_nj.js";import"./EmptyStateSecondaryActions-G5doWCZ5.js";import"./_baseRest-lI6NnEVt.js";import"./DataListItemRow-te2VcAoi.js";import"./data-list-CDN1kyj9.js";import"./plus-icon-zbmNbCLY.js";import"./MenuList-82IaVNxu.js";const pe=t=>{var{className:a="",children:n,hasNoPadding:i=!1}=t,c=oe(t,["className","children","hasNoPadding"]);return X.createElement("div",Object.assign({className:ie(Y.drawerBody,i&&Y.modifiers.noPadding,a)},c),n)};pe.displayName="DrawerPanelBody";const he=t=>{var{className:a="",children:n,hasNoPadding:i=!1}=t,c=oe(t,["className","children","hasNoPadding"]);return X.createElement(pe,{hasNoPadding:i},X.createElement("div",Object.assign({className:ie(Y.drawerHead,a)},c),n))};he.displayName="DrawerHead";const Je={name:"TreeIcon",height:512,width:384,svgPath:"M378.31 378.49L298.42 288h30.63c9.01 0 16.98-5 20.78-13.06 3.8-8.04 2.55-17.26-3.28-24.05L268.42 160h28.89c9.1 0 17.3-5.35 20.86-13.61 3.52-8.13 1.86-17.59-4.24-24.08L203.66 4.83c-6.03-6.45-17.28-6.45-23.32 0L70.06 122.31c-6.1 6.49-7.75 15.95-4.24 24.08C69.38 154.65 77.59 160 86.69 160h28.89l-78.14 90.91c-5.81 6.78-7.06 15.99-3.27 24.04C37.97 283 45.93 288 54.95 288h30.63L5.69 378.49c-6 6.79-7.36 16.09-3.56 24.26 3.75 8.05 12 13.25 21.01 13.25H160v24.45l-30.29 48.4c-5.32 10.64 2.42 23.16 14.31 23.16h95.96c11.89 0 19.63-12.52 14.31-23.16L224 440.45V416h136.86c9.01 0 17.26-5.2 21.01-13.25 3.8-8.17 2.44-17.47-3.56-24.26z",yOffset:0,xOffset:0},Xe=ye(Je),Ye=()=>{const{t}=D(),{clear:a,remove:n,subGroups:i}=H(),{realm:c}=ee(),o=q();return be(()=>{const{pathname:l}=o;(!l.includes("/groups")||l.endsWith("/groups"))&&a()},[o]),i.length!==0?T(fe,{children:[e(ae,{children:e(z,{to:`/${c}/groups`,children:t("groups")})},"home"),i.map((l,u)=>{const s=u===i.length-1;return T(ae,{isActive:s,children:[!s&&e(z,{to:o.pathname.substring(0,o.pathname.indexOf(l.id)+l.id.length),onClick:()=>n(l),children:l.name}),s&&(l.id==="search"?l.name:t("groupDetails"))]},l.id)})]}):null},ge=t=>{const a=t.substr(1).split("/");return a.length>1?a.splice(2):void 0},J=t=>{const a=ge(t);return a?a[a.length-1]:void 0},Ze=()=>{const{t}=D(),{addAlert:a,addError:n}=Q(),i=Ge({mode:"onChange"}),c=q(),o=J(c.pathname),[l,u]=h();te(()=>p.groups.findOne({id:o}),y=>{ve(y,i.setValue),u(y)},[o]);const s=async y=>{try{const g=Me(y).attributes;await p.groups.update({id:o},{...l,attributes:g}),u({...l,attributes:g}),a(t("groupUpdated"),B.success)}catch(g){n("groupUpdateError",g)}};return e(ce,{variant:le.light,children:e(Ve,{form:i,save:s,fineGrainedAccess:l?.access?.manage,reset:()=>i.reset({attributes:we(l?.attributes)})})})},et=({id:t,name:a})=>{const{t:n}=D(),{addAlert:i,addError:c}=Q();return e(Be,{name:a,id:t,type:"groups",save:async l=>{try{const u=l.filter(s=>s.client===void 0).map(s=>s.role).flat();await p.groups.addRealmRoleMappings({id:t,roles:u}),await Promise.all(l.filter(s=>s.client!==void 0).map(s=>p.groups.addClientRoleMappings({id:t,clientUniqueId:s.client.id,roles:[s.role]}))),i(n("roleMappingUpdatedSuccess"),B.success)}catch(u){c("roleMappingUpdatedError",u)}}})},tt=({toggleCreate:t,toggleDelete:a,kebabDisabled:n})=>{const{t:i}=D(),{currentGroup:c}=H(),{hasAccess:o}=W(),l=o("manage-users")||c()?.access?.manage,[u,s]=j();return l?T(k,{children:[e(E,{children:e($,{"data-testid":"openCreateGroupModal",variant:"primary",onClick:t,children:i("createGroup")})}),e(E,{children:e(de,{toggle:e(ue,{onToggle:s,isDisabled:n}),isOpen:u,isPlain:!0,dropdownItems:[e(_,{component:"button",onClick:()=>{a(),s()},children:i("delete")},"action")]})})]}):e("div",{})},ne=({refresh:t,canViewDetails:a})=>{const{t:n}=D(),[i,c]=h([]),[o,l]=h(),[u,s]=j(),[y,g]=j(),[G,w]=h(),{currentGroup:m}=H(),[v,F]=h(0),M=()=>F(v+1),[K,P]=h(),C=q(),A=J(C.pathname),{hasAccess:L}=W(),N=L("manage-users")||m()?.access?.manage,O=async(r,f)=>{let d;if(A){const I={first:r,max:f,parentId:A};d=await p.groups.listSubGroups(I)}else{const I={search:K||"",first:r||void 0,max:f||void 0};d=await p.groups.find(I)}return d};return T(k,{children:[e(me,{show:y,toggleDialog:g,selectedRows:i,refresh:()=>{M(),t(),c([])}}),o&&e(Z,{id:o.id,rename:o,refresh:()=>{M(),t()},handleModalToggle:()=>l(void 0)}),u&&e(Z,{id:i[0]?.id||A,handleModalToggle:s,refresh:()=>{c([]),M(),t()}}),G&&e(je,{source:G,refresh:()=>{w(void 0),M(),t()},onClose:()=>w(void 0)}),e(re,{onSelect:r=>c([...r]),canSelectAll:!0,loader:O,ariaLabelKey:"groups",isPaginated:!0,isSearching:!!K,toolbarItem:T(k,{children:[e(E,{children:e(ze,{"data-testid":"group-search",placeholder:n("filterGroups"),value:K,onChange:(r,f)=>{P(f)},onSearch:M,onClear:()=>{P(""),M()}})}),e(tt,{toggleCreate:s,toggleDelete:g,kebabDisabled:i.length===0})]}),actions:N?[{title:n("rename"),onRowClick:async r=>(l(r),!1)},{title:n("moveTo"),onRowClick:async r=>(w(r),!1)},{title:n("createChildGroup"),onRowClick:async r=>(c([r]),s(),!1)},{isSeparator:!0},{title:n("delete"),onRowClick:async r=>(c([r]),g(),!0)}]:[],columns:[{name:"name",displayKey:"groupName",cellRenderer:r=>a?e(z,{to:`${C.pathname}/${r.id}`,children:r.name},r.id):e("span",{children:r.name})}],emptyState:e(se,{hasIcon:!0,message:n(`noGroupsInThis${A?"SubGroup":"Realm"}`),instructions:n(`noGroupsInThis${A?"SubGroup":"Realm"}Instructions`),primaryActionText:n("createGroup"),onPrimaryAction:s})},`${A}${v}`)]})},st=({groupId:t,onClose:a})=>{const{t:n}=D(),{addAlert:i,addError:c}=Q(),[o,l]=h([]),u=async(s,y,g)=>{const G=await p.groups.listMembers({id:t}),w={first:s,max:y+G.length,search:g||""};try{const m=await p.users.find({...w});return $e(m,G,"id").slice(0,y)}catch(m){return c("noUsersFoundError",m),[]}};return e(_e,{variant:Qe.large,title:n("addMember"),isOpen:!0,onClose:a,actions:[e($,{"data-testid":"add",variant:"primary",onClick:async()=>{try{await Promise.all(o.map(s=>p.users.addToGroup({id:s.id,groupId:t}))),a(),i(n("usersAdded",{count:o.length}),B.success)}catch(s){c("usersAddedError",s)}},children:n("add")},"confirm"),e($,{"data-testid":"cancel",variant:"link",onClick:a,children:n("cancel")},"cancel")],children:e(re,{loader:u,isPaginated:!0,ariaLabelKey:"titleUsers",searchPlaceholderKey:"searchForUser",canSelectAll:!0,onSelect:s=>l([...s]),emptyState:e(se,{message:n("noUsersFound"),instructions:n("emptyInstructions")}),columns:[{name:"username",displayKey:"username"},{name:"email",displayKey:"email"},{name:"lastName",displayKey:"lastName",cellFormatters:[V()]},{name:"firstName",displayKey:"firstName",cellFormatters:[V()]}]})})},rt=t=>e(k,{children:t.membership.map((a,n)=>T(k,{children:[e(He,{group:a},a.id+"-"+t.id),t.membership[n+1]?", ":""]}))}),at=t=>{const{realm:a}=ee();return e(z,{to:Te({realm:a,id:t.id,tab:"settings"}),children:t.username},t.id)},nt=()=>{const{t}=D(),{addAlert:a,addError:n}=Q(),i=q(),c=J(i.pathname),[o,l]=h(!1),{currentGroup:u}=H(),[s,y]=h(),[g,G]=h(!1),[w,m]=h(!1),[v,F]=h([]),{hasAccess:M}=W();te(()=>p.groups.findOne({id:u().id}),y,[]);const K=M("manage-users")||s?.access.manageMembership,[P,C]=h(0),A=()=>C(new Date().getTime()),L=async r=>await p.users.listGroups({id:r}),N=async(r,f=0)=>{let d=[];if(!f||!r)return d;const I={parentId:r,first:0,max:f},S=await p.groups.listSubGroups(I);return d=d.concat(S),await Promise.all(S.map(b=>N(b.id,b.subGroupCount))).then(b=>{b.forEach(R=>d=d.concat(R))}),d},O=async(r,f)=>{if(!c)return[];let d=await p.groups.listMembers({id:c,first:r,max:f});if(o&&s?.subGroupCount&&s.id){const S=await N(s.id,s.subGroupCount);await Promise.all(S.map(b=>p.groups.listMembers({id:b.id}))).then(b=>{b.forEach(R=>d=d.concat(R))}),d=Ke(d,b=>b.username)}const I=await Promise.all(d.map(S=>L(S.id)));return d.map((S,b)=>({...S,membership:I[b]}))};return s?T(k,{children:[g&&e(st,{groupId:c,onClose:()=>{G(!1),A()}}),e(re,{"data-testid":"members-table",loader:O,ariaLabelKey:"members",isPaginated:!0,canSelectAll:!0,onSelect:r=>F([...r]),toolbarItem:K&&T(k,{children:[e(E,{children:e($,{"data-testid":"addMember",variant:"primary",onClick:()=>G(!0),children:t("addMember")})}),e(E,{children:e(Se,{"data-testid":"includeSubGroupsCheck",label:t("includeSubGroups"),id:"kc-include-sub-groups",isChecked:o,onChange:()=>l(!o)})}),e(E,{children:e(de,{toggle:e(ue,{onToggle:()=>m(!w),isDisabled:v.length===0}),isOpen:w,isPlain:!0,dropdownItems:[e(_,{component:"button",onClick:async()=>{try{await Promise.all(v.map(r=>p.users.delFromGroup({id:r.id,groupId:c}))),m(!1),a(t("usersLeft",{count:v.length}),B.success)}catch(r){n("usersLeftError",r)}A()},children:t("leave")},"action")]})})]}),actions:K?[{title:t("leave"),onRowClick:async r=>{try{await p.users.delFromGroup({id:r.id,groupId:c}),a(t("usersLeft",{count:1}),B.success)}catch(f){n("usersLeftError",f)}return!0}}]:[],columns:[{name:"username",displayKey:"name",cellRenderer:at},{name:"email",displayKey:"email",cellFormatters:[V()]},{name:"firstName",displayKey:"firstName",cellFormatters:[V()]},{name:"lastName",displayKey:"lastName",cellFormatters:[V()]},{name:"membership",displayKey:"membership",cellRenderer:rt}],emptyState:e(se,{message:t("noUsersFound"),instructions:K?t("emptyInstructions"):void 0,primaryActionText:K?t("addMember"):void 0,onPrimaryAction:()=>G(!0),secondaryActions:[{text:t("includeSubGroups"),onClick:()=>l(!0)}]})},`${c}${P}${o}`)]}):e(Ce,{})};function Ht(){const{t}=D(),[a,n]=h(0),{subGroups:i,setSubGroups:c,currentGroup:o}=H(),{realm:l}=ee(),[u,s]=h(),[y,g]=j(),G=Pe(),w=q(),m=J(w.pathname),[v,F]=j(!0),[M,K]=h(0),P=()=>K(M+1),{hasAccess:C}=W(),L=xe()(Ue.AdminFineGrainedAuthz)&&C("manage-authorization","manage-users","manage-clients"),N=C("manage-users")||o()?.access?.manage,O=C("manage-users"),r=C("query-groups","view-users")||C("manage-users","query-groups"),f=C("view-users")||o()?.access?.viewMembers||o()?.access?.manageMembers;return te(async()=>{const d=ge(w.pathname);if(d&&d.length>i.length){const S=[];for(const b of d){let R;if(b!=="search"?R=await p.groups.findOne({id:b}):R={name:t("searchGroups"),id:"search"},R)S.push(R);else throw new Error(t("notFound"))}return S}return[]},d=>{d.length&&c(d)},[m]),T(k,{children:[e(me,{show:y,toggleDialog:g,selectedRows:[o()],refresh:()=>{G(Ae({realm:l})),P()}}),u&&e(Z,{id:m,rename:u,refresh:d=>{P(),c([...i.slice(0,i.length-1),d])},handleModalToggle:()=>s(void 0)}),e(ce,{variant:le.light,className:"pf-u-p-0",children:e(Ie,{isInline:!0,isExpanded:v,position:"left",children:e(Re,{panelContent:e(ke,{isResizable:!0,children:e(he,{children:e(qe,{refresh:P,canViewDetails:r})})}),children:T(De,{children:[e(Ne,{content:t(v?"hide":"show"),children:e($,{"aria-label":t(v?"hide":"show"),variant:"plain",icon:v?e(Ee,{}):e(Xe,{}),onClick:F})}),e(Ye,{}),e(Oe,{titleKey:m?o()?.name:"groups",subKey:m?"":"groupsDescription",helpUrl:m?"":Fe.groupsUrl,divider:!m,dropdownItems:m&&N?[e(_,{"data-testid":"renameGroupAction",onClick:()=>s(o()),children:t("renameGroup")},"renameGroup"),e(_,{"data-testid":"deleteGroup",onClick:g,children:t("deleteGroup")},"deleteGroup")]:void 0}),i.length>0&&T(We,{inset:{default:"insetNone",md:"insetSm",xl:"insetLg","2xl":"inset2xl"},activeKey:a,onSelect:(d,I)=>n(I),isBox:!0,mountOnEnter:!0,unmountOnExit:!0,children:[e(x,{"data-testid":"groups",eventKey:0,title:e(U,{children:t("childGroups")}),children:e(ne,{refresh:P,canViewDetails:r})}),f&&e(x,{"data-testid":"members",eventKey:1,title:e(U,{children:t("members")}),children:e(nt,{})}),e(x,{"data-testid":"attributes",eventKey:2,title:e(U,{children:t("attributes")}),children:e(Ze,{})}),O&&e(x,{eventKey:3,"data-testid":"role-mapping-tab",title:e(U,{children:t("roleMapping")}),children:e(et,{id:m,name:o()?.name})}),L&&e(x,{eventKey:4,"data-testid":"permissionsTab",title:e(U,{children:t("permissions")}),children:e(Le,{id:m,type:"groups"})})]}),i.length===0&&e(ne,{refresh:P,canViewDetails:r})]})})},M)})]})}export{Ht as default};
//# sourceMappingURL=GroupsSection-y_zXCtMi.js.map
