import{jsx as e,jsxs as C,Fragment as W}from"react/jsx-runtime";import{useState as P,useMemo as $e,useRef as ct,Fragment as mt}from"react";import{bA as Qe,cc as ut,cd as pt,cg as Oe,cf as ht,ce as ft,ch as Ge,bC as gt,ca as bt,bZ as yt,dQ as wt,dR as Ct,dS as It,dT as vt,dU as kt,dV as Pt,a as Xe,P as de,bO as Te,u as M,f as $,m as ne,j as y,A as B,aj as V,$ as Tt,a0 as Dt,B as U,I as Lt,cl as Rt,ai as xt,K as De,g as he,F as ae,dW as St,dX as Ft,i as Fe,C as Je,Z as Ut,h as Ye,V as j,Q as At,r as Le,O as Ze,a5 as Et,aF as Ve,a7 as Nt,aG as et,bo as Mt,W as Bt,bP as Kt,e as Ue,a4 as Ot,a_ as je,X as be,z as ye,bg as Gt,L as Vt,bT as jt,p as Re,d as Ht,da as qt,E as _t,b2 as zt,b3 as Wt,dN as $t,dO as Qt}from"./index-sihFV1NS.js";import{u as le,C as tt}from"./ConfirmDialog-WMVurgkl.js";import{R as Xt,u as Jt}from"./RoutableTabs-a7VqIL_I.js";import{V as Yt}from"./ViewHeader-xo54NRb6.js";import{U as Zt}from"./UserProfileContext-1YYbbzWi.js";import{u as er,F as tr}from"./useIsFeatureEnabled-qmmJPqO8.js";import{u as Ae}from"./useParams-OD1jI_R2.js";import{A as rr}from"./AttributeForm-St-qQE3r.js";import{a as xe,R as sr,F as ar,U as nr,t as ir}from"./UserForm-KWIpw6L8.js";import{i as or,L as Ee}from"./PaginatingTableToolbar--Dt3wwL6.js";import{K as Ce,T as dr,m as lr,n as cr,P as mr}from"./KeycloakDataTable-Q3kZYP9q.js";import{u as rt}from"./useFormatDate-kyFeutIw.js";import{s as st}from"./sortBy-zPScg0cx.js";import{N,X as ur,S as F,T as He,O as qe,P as ue,Q as z,R as _e,V as Pe}from"./Td-uwYquKT4.js";import{C as pr,S as hr}from"./SessionsTable-fP9nbE0z.js";import{u as Se}from"./useToggle-mZS4AEtR.js";import{u as fr}from"./useLocaleSort-K-jL4v2R.js";import{M as at,a as Ne}from"./Modal-uOAPm2rX.js";import{K as we}from"./KeycloakTextInput--S1SG2UN.js";import{F as Ie}from"./Form-bfj-xQZn.js";import{T as gr}from"./TimeSelector-UGEjvSE_.js";import{P as ze}from"./PasswordInput-P6txGPqu.js";import{G as br,b as yr}from"./GroupPickerDialog-gC2-xBPw.js";import{b as wr}from"./_baseRest-lI6NnEVt.js";import{Q as Cr}from"./question-circle-icon-0KWACECW.js";import{c as pe}from"./capitalize-msOXuIMv.js";import{R as Ir}from"./AddRoleMappingModal-uxjjMt5W.js";import{i as vr}from"./utils-ATQIxiIC.js";/* empty css                     */import{a as re,b as se}from"./Tabs-wiayO8Tk.js";import"react-dom";import"./ToolbarContent-46I9Yg7h.js";import"./FormAccess-EK-4wbwg.js";import"./copy-icon-WaWzxYgU.js";import"./KeyValueInput-CbiNnu-2.js";import"./minus-icon-3MARcJXf.js";import"./ActionListItem-1jrwMZdM.js";import"./EmptyStateBody-jnnI7hpP.js";import"./EmptyStateSecondaryActions-G5doWCZ5.js";import"./TableToolbar-vuixsfwd.js";import"./grip-vertical-icon-accuSWkz.js";import"./ListItem-zTOCxRJG.js";import"./DataListItemRow-te2VcAoi.js";import"./data-list-CDN1kyj9.js";import"./resource-BRtaBrSc.js";import"./filter-icon-0B3gA_nj.js";import"./plus-icon-zbmNbCLY.js";import"./MenuList-82IaVNxu.js";var kr=Math.min;function Pr(t,r,a){for(var p=a?ht:ft,n=t[0].length,g=t.length,c=g,m=Array(g),l=1/0,f=[];c--;){var d=t[c];c&&r&&(d=Qe(d,ut(r))),l=kr(d.length,l),m[c]=!a&&(r||n>=120&&d.length>=120)?new pt(c&&d):void 0}d=t[0];var i=-1,R=m[0];e:for(;++i<n&&f.length<l;){var u=d[i],T=r?r(u):u;if(u=a||u!==0?u:0,!(R?Oe(R,T):p(f,T,a))){for(c=g;--c;){var b=m[c];if(!(b?Oe(b,T):p(t[c],T,a)))continue e}R&&R.push(T),f.push(u)}}return f}function Tr(t){return or(t)?t:[]}var Dr=wr(function(t){var r=Ge(t),a=Qe(t,Tr);return r===Ge(a)?r=void 0:a.pop(),a.length&&a[0]===t[0]?Pr(a,gt(r)):[]});const Lr=Dr;var Rr="[object Map]",xr="[object Set]",Sr=Object.prototype,Fr=Sr.hasOwnProperty;function We(t){if(t==null)return!0;if(bt(t)&&(yt(t)||typeof t=="string"||typeof t.splice=="function"||wt(t)||Ct(t)||It(t)))return!t.length;var r=vt(t);if(r==Rr||r==xr)return!t.size;if(kt(t))return!Pt(t).length;for(var a in t)if(Fr.call(t,a))return!1;return!0}const Ur=({user:t,save:r})=>{const a=Xe();return e(de,{variant:Te.light,children:e(rr,{form:a,save:r,fineGrainedAccess:t.access?.manage,reset:()=>a.reset({...a.getValues(),attributes:xe(t,!1).attributes})})})},Ar=()=>{const[t,r]=P(),{t:a}=M(),{addAlert:p,addError:n}=$(),g=rt(),[c,m]=P(0),{id:l}=Ae(),f=b=>st(b,A=>A.clientId?.toUpperCase()),d=()=>m(new Date().getTime()),i=async()=>{const b=await y.users.listConsents({id:l});return f(b)},R=({grantedClientScopes:b})=>e(Tt,{className:"kc-consents-chip-group",children:b.map(A=>e(Dt,{isReadOnly:!0,className:"kc-consents-chip",children:A},A))}),[u,T]=le({titleKey:"revokeClientScopesTitle",messageKey:a("revokeClientScopes",{clientId:t?.clientId}),continueButtonLabel:"revoke",continueButtonVariant:ne.danger,onConfirm:async()=>{try{await y.users.revokeConsent({id:l,clientId:t.clientId}),d(),p(a("deleteGrantsSuccess"),B.success)}catch(b){n("deleteGrantsError",b)}}});return C(W,{children:[e(T,{}),e(Ce,{loader:i,ariaLabelKey:"roleList",searchPlaceholderKey:" ",columns:[{name:"clientId",displayKey:"Client",cellFormatters:[V()],transforms:[N(20)]},{name:"grantedClientScopes",displayKey:"grantedClientScopes",cellFormatters:[V()],cellRenderer:R,transforms:[N(30)]},{name:"createDate",displayKey:"created",transforms:[N(20)],cellRenderer:({createDate:b})=>b?g(new Date(b)):"—"},{name:"lastUpdatedDate",displayKey:"lastUpdated",transforms:[N(10)],cellRenderer:({lastUpdatedDate:b})=>b?g(new Date(b)):"—"}],actions:[{title:a("revoke"),onRowClick:b=>{r(b),u()}}],emptyState:e(Ee,{hasIcon:!0,icon:pr,message:a("noConsents"),instructions:a("noConsentsText")})},c)]})},Er=({credentialData:t,onClose:r})=>{const{t:a}=M();return e(at,{variant:Ne.medium,title:a("passwordDataTitle"),"data-testid":"passwordDataDialog",isOpen:!0,onClose:r,children:C(dr,{"aria-label":a("passwordDataTitle"),"data-testid":"password-data-dialog",variant:ur.compact,cells:[a("showPasswordDataName"),a("showPasswordDataValue")],rows:t,children:[e(lr,{}),e(cr,{})]})})},Nr=({credential:t,resetPassword:r,toggleDelete:a,children:p})=>{const n=rt(),{t:g}=M(),[c,m]=Se(),[l,f]=Se(),d=fr(),i=$e(()=>{if(!t.credentialData)return[];const R=JSON.parse(t.credentialData);return d(Object.entries(R),([u])=>u).map(([u,T])=>typeof T=="string"?[u,T]:[u,JSON.stringify(T)])},[t.credentialData]);return C(W,{children:[c&&Object.keys(t).length!==0&&e(Er,{credentialData:i,onClose:()=>{m()}}),e(F,{children:p}),e(F,{children:n(new Date(t.createdDate))}),e(F,{children:e(U,{className:"kc-showData-btn",variant:"link","data-testid":"showDataBtn",onClick:m,children:g("showDataBtn")})}),t.type==="password"?e(F,{isActionCell:!0,children:e(U,{variant:"secondary","data-testid":"resetPasswordBtn",onClick:r,children:g("resetPasswordBtn")})}):e(F,{}),e(F,{isActionCell:!0,children:e(Lt,{isPlain:!0,position:Rt.right,toggle:e(xt,{onToggle:f}),isOpen:l,dropdownItems:[e(De,{"data-testid":"deleteDropdownItem",component:"button",onClick:()=>{a(),f()},children:g("deleteBtn")},t.id)]})})]})},Mr=({userId:t,credential:r,isEditable:a,toggle:p})=>{const{t:n}=M(),{register:g,handleSubmit:c}=he(),{addAlert:m,addError:l}=$();return e(Ie,{isHorizontal:!0,className:"kc-form-userLabel",onSubmit:c(async d=>{try{await y.users.updateCredentialLabel({id:t,credentialId:r.id},d.userLabel||""),m(n("updateCredentialUserLabelSuccess"),B.success),p()}catch(i){l("updateCredentialUserLabelError",i)}}),children:e(ae,{fieldId:"kc-userLabel",className:"kc-userLabel-row",children:e("div",{className:"kc-form-group-userLabel",children:a?C(W,{children:[e(we,{"data-testid":"userLabelFld",defaultValue:r.userLabel,className:"kc-userLabel","aria-label":n("userLabel"),...g("userLabel")}),C("div",{className:"kc-userLabel-actionBtns",children:[e(U,{"data-testid":"editUserLabelAcceptBtn",variant:"link",className:"kc-editUserLabelAcceptBtn",type:"submit",icon:e(St,{})}),e(U,{"data-testid":"editUserLabelCancelBtn",variant:"link",className:"kc-editUserLabel-cancelBtn",onClick:p,icon:e(Ft,{})})]})]}):C(W,{children:[r.userLabel,e(U,{"aria-label":n("editUserLabel"),variant:"link",className:"kc-editUserLabel-btn",onClick:p,"data-testid":"editUserLabelBtn",icon:e(mr,{})})]})})})})},Br=()=>{const{t}=M(),{control:r}=Xe();return e(ae,{fieldId:"lifespan",label:t("lifespan"),isStack:!0,labelIcon:e(Fe,{helpText:t("lifespanHelp"),fieldLabelId:"lifespan"}),children:e(Je,{name:"lifespan",defaultValue:nt.lifespan,control:r,render:({field:a})=>e(gr,{value:a.value,units:["minute","hour","day"],onChange:a.onChange,menuAppendTo:"parent"})})})},nt={actions:[],lifespan:43200},Kr=({userId:t,onClose:r})=>{const{t:a}=M(),p=he({defaultValues:nt}),{handleSubmit:n,control:g}=p,c=Ut({control:g,name:"actions"}),m=!We(c),{addAlert:l,addError:f}=$(),d=async({actions:i,lifespan:R})=>{if(!We(i))try{await y.users.executeActionsEmail({id:t,actions:i,lifespan:R}),l(a("credentialResetEmailSuccess"),B.success),r()}catch(u){f("credentialResetEmailError",u)}};return e(tt,{variant:Ne.medium,titleKey:"credentialReset",open:!0,onCancel:r,toggleDialog:r,continueButtonLabel:"credentialResetConfirm",onConfirm:()=>{n(d)()},confirmButtonDisabled:!m,children:C(Ie,{id:"userCredentialsReset-form",isHorizontal:!0,"data-testid":"credential-reset-modal",children:[e(sr,{control:g,name:"actions",label:"resetAction",help:"resetActions"}),e(Ye,{...p,children:e(Br,{})})]})})},Or={password:"",passwordConfirmation:"",temporaryPassword:!0},Gr=({user:t,isResetPassword:r,refresh:a,onClose:p})=>{const{t:n}=M(),{register:g,control:c,formState:{isValid:m,errors:l},watch:f,handleSubmit:d,clearErrors:i,setError:R}=he({defaultValues:Or,mode:"onChange"}),[u,T]=Se(!0),b=f("password",""),A=f("passwordConfirmation",""),{addAlert:Q,addError:X}=$(),[K,H]=le({titleKey:r?"resetPasswordConfirm":"setPasswordConfirm",messageKey:r?n("resetPasswordConfirmText",{username:t.username}):n("setPasswordConfirmText",{username:t.username}),continueButtonLabel:r?"resetPassword":"savePassword",continueButtonVariant:ne.danger,onConfirm:()=>d(S)()}),S=async({password:h,temporaryPassword:o})=>{try{await y.users.resetPassword({id:t.id,credential:{temporary:o,type:"password",value:h}});const O=(await y.users.getCredentials({id:t.id})).find(J=>J.type==="password");O&&await y.users.updateCredentialLabel({id:t.id,credentialId:O.id},n("defaultPasswordLabel")),Q(n(r?"resetCredentialsSuccess":"savePasswordSuccess"),B.success),a()}catch(D){X(r?"resetPasswordError":"savePasswordError",D)}p()},{onChange:v,...E}=g("password",{required:!0});return C(W,{children:[e(H,{}),e(tt,{titleKey:r?n("resetPasswordFor",{username:t.username}):n("setPasswordFor",{username:t.username}),open:u,onCancel:p,toggleDialog:T,onConfirm:K,confirmButtonDisabled:!m,continueButtonLabel:"save",children:C(Ie,{id:"userCredentials-form",isHorizontal:!0,className:"keycloak__user-credentials__reset-form",children:[e(ae,{name:"password",label:n("password"),fieldId:"password",helperTextInvalid:n("required"),validated:l.password?j.error:j.default,isRequired:!0,children:e(ze,{"data-testid":"passwordField",id:"password",onChange:h=>{v(h),A!==h.currentTarget.value?R("passwordConfirmation",{message:n("confirmPasswordDoesNotMatch").toString()}):i("passwordConfirmation")},...E})}),e(ae,{name:"passwordConfirmation",label:n(r?"resetPasswordConfirmation":"passwordConfirmation"),fieldId:"passwordConfirmation",helperTextInvalid:l.passwordConfirmation?.message,validated:l.passwordConfirmation?j.error:j.default,isRequired:!0,children:e(ze,{"data-testid":"passwordConfirmationField",id:"passwordConfirmation",...g("passwordConfirmation",{required:!0,validate:h=>h===b||n("confirmPasswordDoesNotMatch").toString()})})}),e(ae,{label:n("temporaryPassword"),labelIcon:e(Fe,{helpText:n("temporaryPasswordHelpText"),fieldLabelId:"temporaryPassword"}),fieldId:"kc-temporaryPassword",children:e(Je,{name:"temporaryPassword",defaultValue:!0,control:c,render:({field:h})=>e(At,{className:"kc-temporaryPassword",onChange:h.onChange,isChecked:h.value,label:n("on"),labelOff:n("off"),"aria-label":n("temporaryPassword")})})})]})})]})},Vr=({user:t})=>{const{t:r}=M(),{addAlert:a,addError:p}=$(),[n,g]=P(0),c=()=>g(n+1),[m,l]=P(!1),[f,d]=P(!1),[i,R]=P([]),[u,T]=P([]),[b,A]=P({}),[Q,X]=P(!1),[K,H]=P(),S=ct(null),[v,E]=P({draggedItemId:"",draggingToItemIndex:-1,dragging:!1,tempItemOrder:[""]});Le(()=>y.users.getCredentials({id:t.id}),s=>{R(s);const I=s.reduce((k,x)=>(k[x.type]=k[x.type]||[],k[x.type].push(x),k),Object.create(null)),w=Object.keys(I).map(k=>({key:k,value:I[k]}));T(w.map(k=>({...k,isExpanded:!1})))},[n]);const h=i.find(s=>s.type==="password"),o=()=>l(!m),D=()=>{d(!f)},O=()=>{X(!0),o()},[J,ce]=le({titleKey:r("deleteCredentialsConfirmTitle"),messageKey:r("deleteCredentialsConfirm"),continueButtonLabel:r("delete"),continueButtonVariant:ne.danger,onConfirm:async()=>{try{await y.users.deleteCredential({id:t.id,credentialId:b.id}),a(r("deleteCredentialsSuccess"),B.success),g(s=>s+1)}catch(s){p("deleteCredentialsError",s)}}}),Y=({credential:s})=>e(Nr,{credential:s,toggleDelete:()=>{A(s),J()},resetPassword:O,children:e(Mr,{credential:s,userId:t.id,isEditable:K?.status&&K.rowKey===s.id||!1,toggle:()=>{H({status:!K?.status,rowKey:s.id}),K?.status&&c()}})},s.id),q=$e(()=>u.flatMap(s=>[s.value.map(({id:I})=>I).toString(),...s.isExpanded?s.value.map(I=>I.id):[]]),[u]),Z=s=>{s.dataTransfer.effectAllowed="move",s.dataTransfer.setData("text/plain",s.currentTarget.id);const I=s.currentTarget.id;s.currentTarget.classList.add(Pe.modifiers.ghostRow),s.currentTarget.setAttribute("aria-pressed","true"),E({...v,draggedItemId:I,dragging:!0})},me=(s,I,w)=>{const k=s.indexOf(I);if(k===w)return s;const x=[...s];return x.splice(w,0,x.splice(k,1)[0]),x},ee=s=>{if(!S.current)return;const I=S.current,w=Array.from(I.children);w.every(({id:k},x)=>k===s[x])||(I.replaceChildren(),s.forEach(k=>{I.appendChild(w.find(({id:x})=>x===k))}))},ve=()=>{S.current&&(Array.from(S.current.children).forEach(s=>{s.classList.remove(Pe.modifiers.ghostRow),s.setAttribute("aria-pressed","false")}),E({...v,draggedItemId:"",draggingToItemIndex:-1,dragging:!1}))},L=s=>{_(s)||(ee(q),E({...v,draggingToItemIndex:-1}))},_=s=>{if(!S.current)return!1;const I=S.current.getBoundingClientRect();return s.clientX>I.x&&s.clientX<I.x+I.width&&s.clientY>I.y&&s.clientY<I.y+I.height},ie=s=>{_(s)?ge(v.draggedItemId,v.tempItemOrder):ve()},oe=s=>{s.preventDefault();const w=s.target.closest("tr");if(!(!w||S.current&&!S.current.contains(w)||w.id===v.draggedItemId)){const k=w.id,x=Array.from(S.current?.children||[]).findIndex(G=>G.id===k);if(x===v.draggingToItemIndex)return;const te=me(q,v.draggedItemId,x);ee(te),E({...v,draggingToItemIndex:x,tempItemOrder:te})}},fe=({target:s})=>{s instanceof HTMLTableRowElement&&(s.classList.remove(Pe.modifiers.ghostRow),s.setAttribute("aria-pressed","false"),E({...v,draggedItemId:"",draggingToItemIndex:-1,dragging:!1}))},ge=async(s,I)=>{const w=q.findIndex(G=>G===s),k=I.findIndex(G=>G===s),x=k-w,te=s.split(",");try{for(const G of te)for(let Ke=0;Ke<Math.abs(x);Ke++)x>0?await y.users.moveCredentialPositionDown({id:t.id,credentialId:G,newPreviousCredentialId:q[k]}):await y.users.moveCredentialPositionUp({id:t.id,credentialId:G});c(),a(r("updatedCredentialMoveSuccess"),B.success)}catch(G){p("updatedCredentialMoveError",G)}},it=t.federationLink||t.origin,[ke,ot]=P([]);if(Le(()=>y.users.getUserStorageCredentialTypes({id:t.id}),ot,[]),!ke)return e(Ze,{});const Me=ke.length>0,dt=u.length===0,lt=!t.credentials||t.credentials.length===0,Be=dt&&lt&&!Me;return C(W,{children:[m&&e(Gr,{user:t,isResetPassword:Q,refresh:c,onClose:()=>l(!1)}),f&&e(Kr,{userId:t.id,onClose:()=>d(!1)}),e(ce,{}),t.email&&!Be&&e(U,{className:"kc-resetCredentialBtn-header",variant:"primary","data-testid":"credentialResetBtn",onClick:()=>d(!0),children:r("credentialResetBtn")}),i.length!==0&&h===void 0&&C(W,{children:[e(U,{className:"kc-setPasswordBtn-tbl","data-testid":"setPasswordBtn-table",variant:"primary",form:"userCredentials-form",onClick:()=>{l(!0)},children:r("setPassword")}),e(Et,{})]}),u.length!==0&&e(de,{variant:Te.light,children:C(He,{variant:"compact",children:[e(qe,{children:C(ue,{className:"kc-table-header",children:[e(z,{children:e(Fe,{helpText:r("userCredentialsHelpText"),fieldLabelId:"userCredentialsHelpTextLabel"})}),e(z,{"aria-hidden":"true"}),e(z,{children:r("type")}),e(z,{children:r("userLabel")}),e(z,{children:r("createdAt")}),e(z,{children:r("data")}),e(z,{"aria-hidden":"true"}),e(z,{"aria-hidden":"true"})]})}),e(_e,{ref:S,onDragOver:oe,onDrop:oe,onDragLeave:L,children:u.map((s,I)=>C(mt,{children:[C(ue,{id:s.value.map(({id:w})=>w).toString(),draggable:u.length>1,onDrop:ie,onDragEnd:fe,onDragStart:Z,children:[e(F,{className:u.length===1?"one-row":"",draggableRow:{id:`draggable-row-${s.value.map(({id:w})=>w)}`}}),s.value.length>1?e(F,{className:"kc-expandRow-btn",expand:{rowIndex:I,isExpanded:s.isExpanded,onToggle:(w,k)=>{const x=u.map((te,G)=>G===k?{...te,isExpanded:!te.isExpanded}:te);T(x)}}}):e(F,{}),e(F,{dataLabel:`columns-${s.key}`,className:"kc-notExpandableRow-credentialType","data-testid":"credentialType",children:Ve(s.key)}),s.value.length<=1&&s.value.map(w=>e(Y,{credential:w},w.id))]}),s.isExpanded&&s.value.map(w=>C(ue,{id:w.id,draggable:!0,onDrop:ie,onDragEnd:fe,onDragStart:Z,children:[e(F,{}),e(F,{className:"kc-draggable-dropdown-type-icon",draggableRow:{id:`draggable-row-${s.value.map(({id:k})=>k)}`}}),e(F,{dataLabel:`child-columns-${w.id}`,className:"kc-expandableRow-credentialType",children:Ve(w.type)}),e(Y,{credential:w})]},w.id))]},s.key))})]})}),it&&Me&&e(de,{variant:Te.light,children:C(He,{variant:"compact",children:[e(qe,{children:C(ue,{children:[e(z,{children:r("type")}),e(z,{children:r("providedBy")}),e(z,{"aria-hidden":"true"})]})}),e(_e,{children:ke.map(s=>C(ue,{children:[e(F,{children:e("b",{children:s})}),e(F,{children:e(ar,{user:t})}),s==="password"&&e(F,{modifier:"fitContent",children:e(U,{variant:"secondary",onClick:o,children:r("setPassword")})})]},s))})]})}),Be&&e(Ee,{hasIcon:!0,message:r("noCredentials"),instructions:r("noCredentialsText"),primaryActionText:r("setPassword"),onPrimaryAction:o,secondaryActions:t.email?[{text:r("credentialResetBtn"),onClick:D,type:ne.link}]:void 0})]})},jr=({user:t})=>{const{t:r}=M(),{addAlert:a,addError:p}=$(),[n,g]=P(0),c=()=>g(n+1),[m,l]=P([]),[f,d]=P(!0),[i,R]=P([]),[u,T]=P(!1),{enabled:b}=Nt(),{hasAccess:A}=et(),Q=A("manage-users"),X=o=>st(o,D=>D.path?.toUpperCase()),K=async(o,D,O)=>{const J={first:o,max:D},ce=O||"";ce&&(J.search=ce);const Y=await y.users.listGroups({...J,id:t.id});R([...Y]);const q=[];return f||Y.forEach(Z=>{const me=Z.path?.substring(1).split("/").slice(0,-1)||[];q.push(...me.map(ee=>({name:ee,path:Z.path?.substring(0,Z.path.indexOf(ee)+ee.length)})))}),X(Kt([...Y,...q],"path"))},H=()=>{T(!u)},[S,v]=le({titleKey:r("leaveGroup",{count:m.length,name:m[0]?.name}),messageKey:r("leaveGroupConfirmDialog",{count:m.length,groupname:m[0]?.name,username:t.username}),continueButtonLabel:"leave",continueButtonVariant:ne.danger,onConfirm:async()=>{try{await Promise.all(m.map(o=>y.users.delFromGroup({id:t.id,groupId:o.id}))),a(r("removedGroupMembership"),B.success)}catch(o){p("removedGroupMembershipError",o)}c()}}),E=o=>{l(o),S()},h=async o=>{try{await Promise.all(o.map(D=>y.users.addToGroup({id:t.id,groupId:D.id}))),a(r("addedGroupMembership"),B.success)}catch(D){p("addedGroupMembershipError",D)}c()};return C(W,{children:[e(v,{}),u&&e(br,{id:t.id,type:"selectMany",text:{title:r("joinGroupsFor",{username:t.username}),ok:"join"},canBrowse:Q,onClose:()=>T(!1),onConfirm:async(o=[])=>{await h(o),T(!1)}}),e(Ce,{loader:K,className:"keycloak_user-section_groups-table",isPaginated:!0,ariaLabelKey:"roleList",searchPlaceholderKey:"searchGroup",canSelectAll:!0,onSelect:o=>l(f?o:Lr(o,i,"id")),isRowDisabled:o=>!f&&i.every(D=>D.id!==o.id),toolbarItem:C(W,{children:[e(U,{className:"kc-join-group-button",onClick:H,"data-testid":"add-group-button",isDisabled:!t.access?.manageGroupMembership,children:r("joinGroup")}),e(Mt,{label:r("directMembership"),id:"kc-direct-membership-checkbox",onChange:()=>{d(!f),c()},isChecked:f,className:"direct-membership-check"},"direct-membership-check"),e(U,{onClick:()=>E(m),"data-testid":"leave-group-button",variant:"link",isDisabled:m.length===0,children:r("leave")}),b&&e(Bt,{"aria-label":"Basic popover",position:"bottom",bodyContent:e("div",{children:r("whoWillAppearPopoverTextUsers")}),children:e(U,{variant:"link",className:"kc-who-will-appear-button",icon:e(Cr,{}),children:r("whoWillAppearLinkTextUsers")},"who-will-appear-button")})]}),columns:[{name:"groupMembership",displayKey:"groupMembership",cellRenderer:o=>o.name||"",cellFormatters:[V()],transforms:[N(40)]},{name:"path",displayKey:"path",cellRenderer:o=>e(yr,{group:o}),transforms:[N(45)]},{name:"",cellRenderer:o=>i.some(O=>O.id===o.id)||i.length===0||f?e(U,{"data-testid":`leave-${o.name}`,onClick:()=>E([o]),variant:"link",isDisabled:!t.access?.manageGroupMembership,children:r("leave")}):"",cellFormatters:[V()],transforms:[N(20)]}],emptyState:e(Ee,{hasIcon:!0,message:r("noGroups"),instructions:r("noGroupsText"),primaryActionText:r("joinGroup"),onPrimaryAction:H})},n)]})},Hr=({userId:t,federatedId:r,onClose:a,onRefresh:p})=>{const{t:n}=M(),{addAlert:g,addError:c}=$(),{register:m,handleSubmit:l,formState:{isValid:f,errors:d}}=he({mode:"onChange"}),i=async R=>{try{await y.users.addToFederatedIdentity({id:t,federatedIdentityId:r,federatedIdentity:R}),g(n("idpLinkSuccess"),B.success),a(),p()}catch(u){c("couldNotLinkIdP",u)}};return e(at,{variant:Ne.small,title:n("linkAccountTitle",{provider:pe(r)}),onClose:a,actions:[e(U,{"data-testid":"confirm",variant:"primary",type:"submit",form:"group-form",isDisabled:!f,children:n("link")},"confirm"),e(U,{"data-testid":"cancel",variant:ne.link,onClick:a,children:n("cancel")},"cancel")],isOpen:!0,children:C(Ie,{id:"group-form",onSubmit:l(i),children:[e(ae,{label:n("identityProvider"),fieldId:"identityProvider",children:e(we,{id:"identityProvider","data-testid":"idpNameInput",value:pe(r),isReadOnly:!0})}),e(ae,{label:n("userID"),fieldId:"userID",helperText:n("userIdHelperText"),helperTextInvalid:n("required"),validated:d.userId?j.error:j.default,isRequired:!0,children:e(we,{id:"userID","data-testid":"userIdInput",validated:d.userId?j.error:j.default,autoFocus:!0,...m("userId",{required:!0})})}),e(ae,{label:n("username"),fieldId:"username",helperText:n("usernameHelperText"),helperTextInvalid:n("required"),validated:d.userName?j.error:j.default,isRequired:!0,children:e(we,{id:"username","data-testid":"usernameInput",validated:d.userName?j.error:j.default,...m("userName",{required:!0})})})]})})},qr=({userId:t})=>{const[r,a]=P(0),[p,n]=P(""),[g,c]=P(!1),{realm:m}=Ue(),{addAlert:l,addError:f}=$(),{t:d}=M(),i=()=>a(new Date().getTime()),R=Ot().identityProviders,u=async()=>{const h=await y.identityProviders.find(),o=await y.users.listFederatedIdentities({id:t});for(const D of o)D.providerId=h.find(O=>O.alias===D.identityProvider)?.providerId;return o},T=async()=>(await y.realms.findOne({realm:m})).identityProviders,b=async()=>u(),A=async()=>{const h=(await u()).map(o=>o.identityProvider);return(await T())?.filter(o=>!h.includes(o.alias))},[Q,X]=le({titleKey:d("unlinkAccountTitle",{provider:pe(p)}),messageKey:d("unlinkAccountConfirm",{provider:pe(p)}),continueButtonLabel:"unlink",continueButtonVariant:ne.primary,onConfirm:async()=>{try{await y.users.delFromFederatedIdentity({id:t,federatedIdentityId:p}),l(d("idpUnlinkSuccess"),B.success),i()}catch(h){f("mappingDeletedError",h)}}}),K=h=>e(Vt,{to:jt({realm:m,providerId:h.providerId,alias:h.identityProvider,tab:"settings"}),children:pe(h.identityProvider)}),H=h=>{const o=R?.find(D=>D.id===h.identityProvider)?.groupName;return e(Re,{color:o==="Social"?"blue":"orange",children:d(o==="Social"?"idpType.social":"idpType.custom")})},S=h=>{const o=R?.find(D=>D.id===h.providerId)?.groupName;return e(Re,{color:o==="User-defined"?"orange":"blue",children:o==="User-defined"?"Custom":o==="Social"?d("idpType.social"):o})},v=h=>e(U,{variant:"link",onClick:()=>{n(h.identityProvider),Q()},children:d("unlinkAccount")}),E=h=>e(U,{variant:"link",onClick:()=>{n(h.alias),c(!0)},children:d("linkAccount")});return C(W,{children:[g&&e(Hr,{userId:t,federatedId:p,onClose:()=>c(!1),onRefresh:i}),e(X,{}),C(de,{variant:"light",className:"pf-u-p-0",children:[C(je,{title:d("linkedIdPs"),className:"kc-linked-idps",children:[e(be,{children:e(ye,{className:"kc-available-idps-text",children:d("linkedIdPsText")})}),e(Ce,{loader:b,isPaginated:!1,ariaLabelKey:"LinkedIdPs",className:"kc-linked-IdPs-table",columns:[{name:"identityProvider",displayKey:"name",cellFormatters:[V()],cellRenderer:K,transforms:[N(20)]},{name:"type",displayKey:"type",cellFormatters:[V()],cellRenderer:H,transforms:[N(10)]},{name:"userId",displayKey:"userID",cellFormatters:[V()],transforms:[N(30)]},{name:"userName",displayKey:"username",cellFormatters:[V()],transforms:[N(20)]},{name:"",cellFormatters:[V()],cellRenderer:v,transforms:[N(20)]}],emptyState:e(be,{className:"kc-no-providers-text",children:e(ye,{children:d("noProvidersLinked")})})},r)]}),C(je,{className:"kc-available-idps",title:d("availableIdPs"),children:[e(be,{children:e(ye,{className:"kc-available-idps-text",children:d("availableIdPsText")})}),e(Ce,{loader:A,isPaginated:!1,ariaLabelKey:"LinkedIdPs",className:"kc-linked-IdPs-table",columns:[{name:"alias",displayKey:"name",cellFormatters:[V(),Gt()],transforms:[N(20)]},{name:"type",displayKey:"type",cellFormatters:[V()],cellRenderer:S,transforms:[N(60)]},{name:"",cellFormatters:[V()],cellRenderer:E}],emptyState:e(be,{className:"kc-no-providers-text",children:e(ye,{children:d("noAvailableIdentityProviders")})})},r)]})]})]})},_r=({id:t,name:r})=>{const{t:a}=M(),{addAlert:p,addError:n}=$();return e(Ir,{name:r,id:t,type:"users",save:async c=>{try{const m=c.filter(l=>l.client===void 0).map(l=>l.role).flat();await y.users.addRealmRoleMappings({id:t,roles:m}),await Promise.all(c.filter(l=>l.client!==void 0).map(l=>y.users.addClientRoleMappings({id:t,clientUniqueId:l.client.id,roles:[l.role]}))),p(a("userRoleMappingUpdatedSuccess"),B.success)}catch(m){n("roleMappingUpdatedError",m)}}})},zr=()=>{const{id:t}=Ae(),{realm:r}=Ue(),{t:a}=M();return e(de,{variant:"light",className:"pf-u-p-0",children:e(hr,{loader:()=>y.users.listSessions({id:t,realm:r}),hiddenColumns:["username","type"],emptyInstructions:a("noSessionsForUser"),logoutUser:t})})};function Hs(){const{t}=M(),{addAlert:r,addError:a}=$(),p=Ht(),{hasAccess:n}=et(),{id:g}=Ae(),{realm:c}=Ue(),m=er(),l=he({mode:"onChange"}),[f,d]=P(),[i,R]=P(),[u,T]=P(),[b,A]=P(),[Q,X]=P(0),K=()=>X(L=>L+1),H=vr(i?.id),S=L=>Wt({realm:c,id:i?.id||"",tab:L}),v=L=>Jt(S(L)),E=v("settings"),h=v("attributes"),o=v("credentials"),D=v("role-mapping"),O=v("groups"),J=v("consents"),ce=v("identity-provider-links"),Y=v("sessions");Le(async()=>Promise.all([y.realms.findOne({realm:c}),y.users.findOne({id:g,userProfileMetadata:!0}),y.attackDetection.findOne({id:g})]),([L,_,ie])=>{if(!_||!L||!ie)throw new Error(t("notFound"));d(L),R(_);const oe=L.bruteForceProtected,fe=oe&&ie.disabled;T({isBruteForceProtected:oe,isLocked:fe});const ge=m(tr.DeclarativeUserProfile)&&L.attributes?.userProfileEnabled==="true";A(ge?_.userProfileMetadata:void 0),l.reset(xe(_,ge))},[Q]);const q=async L=>{try{await y.users.update({id:i.id},ir(L)),r(t("userSaved"),B.success),K()}catch(_){$t(_)?Qt(_,l.setError,(ie,oe)=>t(ie,{...oe})):a("userCreateError",_)}},[Z,me]=le({titleKey:"deleteConfirm",messageKey:"deleteConfirmCurrentUser",continueButtonLabel:"delete",continueButtonVariant:ne.danger,onConfirm:async()=>{try{H?await y.users.logout({id:i.id}):await y.users.del({id:i.id}),r(t("userDeletedSuccess"),B.success),p(qt({realm:c}))}catch(L){a("userDeletedError",L)}}}),[ee,ve]=le({titleKey:"impersonateConfirm",messageKey:"impersonateConfirmDialog",continueButtonLabel:"impersonate",onConfirm:async()=>{try{const L=await y.users.impersonation({id:i.id},{user:i.id,realm:c});L.sameRealm?window.location=L.redirect:window.open(L.redirect,"_blank")}catch(L){a("impersonateError",L)}}});return!f||!i||!u?e(Ze,{}):C(W,{children:[e(ve,{}),e(me,{}),e(Yt,{titleKey:i.username,className:"kc-username-view-header",divider:!1,badges:H?[{text:e(_t,{content:t("transientUserTooltip"),children:e(Re,{"data-testid":"user-details-label-transient-user",icon:e(zt,{}),children:t("transientUser")})})}]:[],dropdownItems:[e(De,{isDisabled:!i.access?.impersonate,onClick:()=>ee(),children:t("impersonate")},"impersonate"),e(De,{isDisabled:!i.access?.manage,onClick:()=>Z(),children:t("delete")},"delete")],onToggle:L=>q({...xe(i,!!b),enabled:L}),isEnabled:i.enabled}),e(de,{variant:"light",className:"pf-u-p-0",children:e(Zt,{children:e(Ye,{...l,children:C(Xt,{isBox:!0,mountOnEnter:!0,defaultLocation:S("settings"),children:[e(re,{"data-testid":"user-details-tab",title:e(se,{children:t("details")}),...E,children:e(de,{variant:"light",children:e(nr,{form:l,realm:f,user:i,bruteForce:u,userProfileMetadata:b,save:q})})}),!b&&e(re,{"data-testid":"attributes",title:e(se,{children:t("attributes")}),...h,children:e(Ur,{user:i,save:q})}),e(re,{"data-testid":"credentials",isHidden:!i.access?.view,title:e(se,{children:t("credentials")}),...o,children:e(Vr,{user:i})}),e(re,{"data-testid":"role-mapping-tab",isHidden:!i.access?.mapRoles,title:e(se,{children:t("roleMapping")}),...D,children:e(_r,{id:i.id,name:i.username})}),n("query-groups")&&e(re,{"data-testid":"user-groups-tab",title:e(se,{children:t("groups")}),...O,children:e(jr,{user:i})}),e(re,{"data-testid":"user-consents-tab",title:e(se,{children:t("consents")}),...J,children:e(Ar,{})}),n("view-identity-providers")&&e(re,{"data-testid":"identity-provider-links-tab",title:e(se,{children:t("identityProviderLinks")}),...ce,children:e(qr,{userId:i.id})}),e(re,{"data-testid":"user-sessions-tab",title:e(se,{children:t("sessions")}),...Y,children:e(zr,{})})]})})})})]})}export{Hs as default};
//# sourceMappingURL=EditUser-rUVRtrPB.js.map
