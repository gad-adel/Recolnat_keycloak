import{jsx as i,jsxs as s,Fragment as y}from"react/jsx-runtime";import{useState as h}from"react";import{u as A,r as le,O as ne,B as k,p as ve,j as P,e as De,f as Te,d as Se,g as Ne,a4 as we,m as H,A as v,dm as S,dl as N,C as Ie,P as Le,F as U,V as w,z as I,D as L,i as x,L as O,dE as xe,a6 as W,dF as Ke,a5 as X,dq as Ve,K as Ae}from"./index-sihFV1NS.js";import{u as K}from"./ConfirmDialog-WMVurgkl.js";import{F as Fe}from"./FormAccess-EK-4wbwg.js";import{K as Ee}from"./KeycloakTextArea-NBwG1p2x.js";import{K as Re}from"./KeycloakTextInput--S1SG2UN.js";import{V as Be}from"./ViewHeader-xo54NRb6.js";import{u as Me}from"./useParams-OD1jI_R2.js";import{L as He}from"./PaginatingTableToolbar--Dt3wwL6.js";import{K as Oe}from"./KeycloakDataTable-Q3kZYP9q.js";import{M as $e,a as je}from"./Modal-uOAPm2rX.js";/* empty css                               */import{A as qe}from"./Form-bfj-xQZn.js";import{F as Y}from"./Flex-W2FoLD7u.js";import{F as V}from"./FlexItem-Mxf6oLng.js";import{e as Z,D as _,a as ee,c as ie,d as te}from"./DataListItemRow-te2VcAoi.js";import{T as oe}from"./trash-icon-c1moCUVC.js";import"react-dom";import"./copy-icon-WaWzxYgU.js";import"./ToolbarContent-46I9Yg7h.js";import"./EmptyStateBody-jnnI7hpP.js";import"./EmptyStateSecondaryActions-G5doWCZ5.js";import"./TableToolbar-vuixsfwd.js";import"./Td-uwYquKT4.js";import"./grip-vertical-icon-accuSWkz.js";import"./_baseRest-lI6NnEVt.js";import"./data-list-CDN1kyj9.js";const Ge=({name:t,global:n})=>{const{t:m}=A();return s(y,{children:[t," ",n&&i(ve,{color:"blue",children:m("global")})]})},ze=t=>{const{t:n}=A(),[m,C]=h([]),[a,T]=h();le(()=>P.clientPolicies.listProfiles({includeGlobalProfiles:!0}),g=>{const p=g.globalProfiles?.map(u=>({...u,global:!0})),E=g.profiles?.map(u=>({...u,global:!1}));T([...p??[],...E??[]])},[]);const F=async()=>a?.filter(g=>!t.allProfiles.includes(g.name))??[];return a?i($e,{"data-testid":"addClientProfile",title:n("addClientProfile"),isOpen:t.open,onClose:t.toggleDialog,variant:je.large,actions:[i(k,{"data-testid":"add-client-profile-button",variant:"primary",isDisabled:!m.length,onClick:()=>{t.toggleDialog(),t.onConfirm(m)},children:n("add")},"add"),i(k,{variant:"link",onClick:()=>{t.toggleDialog()},children:n("cancel")},"cancel")],children:i(Oe,{loader:F,ariaLabelKey:"profilesList",searchPlaceholderKey:"searchProfile",canSelectAll:!0,onSelect:g=>{C([...g])},columns:[{name:"name",displayKey:"clientProfileName",cellRenderer:Ge},{name:"description",displayKey:"description"}],emptyState:i(He,{hasIcon:!0,message:n("noRoles"),instructions:n("noRolesInstructions"),primaryActionText:n("createRole")})})}):i(ne,{})},Je={name:"",description:"",conditions:[],enabled:!0,profiles:[]};function vi(){const{t}=A(),{realm:n}=De(),{addAlert:m,addError:C}=Te(),[a,T]=h(),[F,g]=h([]),[p,E]=h(),[u,$]=h(!1),[R,ae]=h(),[j,se]=h(!1),[B,re]=h(),{policyName:r}=Me(),b=Se(),c=Ne({mode:"onChange",defaultValues:Je}),{handleSubmit:ce}=c,M=c.getValues(),de=({save:e,onChange:o,value:l})=>{const{t:f}=A(),[d,ke]=K({titleKey:"disablePolicyConfirmTitle",messageKey:"disablePolicyConfirm",continueButtonLabel:"disable",onConfirm:()=>{o(!l),e()}});return a?s(y,{children:[i(ke,{}),i(ue,{}),i(Be,{titleKey:u||r?r:"createPolicy",divider:!0,dropdownItems:u||r?[i(Ae,{value:"delete",onClick:()=>{pe()},"data-testid":"deleteClientPolicyDropdown",children:f("deleteClientPolicy")},"delete")]:void 0,isEnabled:l,onToggle:Q=>{Q?(o(Q),e()):d()}})]}):i(ne,{})};le(async()=>{const[e,o]=await Promise.all([P.clientPolicies.listPolicies(),P.clientPolicies.listProfiles({includeGlobalProfiles:!0})]);return{policies:e,profiles:o}},({policies:e,profiles:o})=>{const l=e.policies?.find(d=>d.name===r),f=[...o.globalProfiles??[],...o.profiles??[]];T(e.policies??[]),l&&(me(l),g(f),E(l),$(!0))},[]);const me=e=>{c.reset(e)},q=(a||[]).filter(e=>e.name===r),G=q[0]?.conditions||[],D=q[0]?.profiles||[],fe=we().componentTypes?.["org.keycloak.services.clientpolicy.condition.ClientPolicyConditionProvider"],z=async()=>{const e=c.getValues(),o={...e,profiles:[],conditions:[]},l=()=>a?.some(d=>d.name===o.name)?a?.map(d=>d.name===o.name?o:d):e.name!==r?a?.filter(d=>d.name!==r).concat(e):a?.concat(e);try{await P.clientPolicies.updatePolicy({policies:l()}),m(t(r?"updateClientPolicySuccess":"createClientPolicySuccess"),v.success),b(N({realm:n,policyName:e.name})),$(!0)}catch(f){C("createClientPolicyError",f)}},[pe,ue]=K({titleKey:t("deleteClientPolicyConfirmTitle"),messageKey:t("deleteClientPolicyConfirm",{policyName:r}),continueButtonLabel:t("delete"),continueButtonVariant:H.danger,onConfirm:async()=>{const e=a?.filter(o=>o.name!==r);try{await P.clientPolicies.updatePolicy({policies:e}),m(t("deleteClientPolicySuccess"),v.success),b(S({realm:n,tab:"policies"}))}catch(o){C(t("deleteClientPolicyError"),o)}}}),[Pe,Ce]=K({titleKey:t("deleteClientPolicyConditionConfirmTitle"),messageKey:t("deleteClientPolicyConditionConfirm",{condition:R?.name}),continueButtonLabel:t("delete"),continueButtonVariant:H.danger,onConfirm:async()=>{if(R?.name){p?.conditions?.splice(R.idx,1);try{await P.clientPolicies.updatePolicy({policies:a}),m(t("deleteConditionSuccess"),v.success),b(N({realm:n,policyName:M.name}))}catch(e){C(t("deleteConditionError"),e)}}else{const e=a?.filter(o=>o.name!==r);try{await P.clientPolicies.updatePolicy({policies:e}),m(t("deleteClientSuccess"),v.success),b(S({realm:n,tab:"policies"}))}catch(o){C(t("deleteClientError"),o)}}}}),[ye,he]=K({titleKey:t("deleteClientPolicyProfileConfirmTitle"),messageKey:t("deleteClientPolicyProfileConfirm",{profileName:B?.name,policyName:r}),continueButtonLabel:t("delete"),continueButtonVariant:H.danger,onConfirm:async()=>{if(B?.name){p?.profiles?.splice(B.idx,1);try{await P.clientPolicies.updatePolicy({policies:a}),m(t("deleteClientPolicyProfileSuccess"),v.success),b(N({realm:n,policyName:M.name}))}catch(e){C(t("deleteClientPolicyProfileError"),e)}}else{const e=a?.filter(o=>o.name!==r);try{await P.clientPolicies.updatePolicy({policies:e}),m(t("deleteClientSuccess"),v.success),b(S({realm:n,tab:"policies"}))}catch(o){C(t("deleteClientError"),o)}}}}),ge=()=>{p?.name!==void 0&&c.setValue("name",p.name),p?.description!==void 0&&c.setValue("description",p.description)},J=()=>{se(!j)},be=async e=>{const o={...p,profiles:D.concat(e),conditions:p?.conditions},l=a?.findIndex(d=>o.name===d.name);if(l===void 0||l===-1)return;const f=[...(a||[]).slice(0,l),o,...(a||[]).slice(l+1)];try{await P.clientPolicies.updatePolicy({policies:f}),T(f),b(N({realm:n,policyName:M.name})),m(t("addClientProfileSuccess"),v.success)}catch(d){C("addClientProfileError",d)}};return s(y,{children:[i(Ce,{}),i(he,{}),i(ze,{onConfirm:e=>{be(e.map(o=>o.name))},allProfiles:D,open:j,toggleDialog:J}),i(Ie,{name:"enabled",defaultValue:!0,control:c.control,render:({field:e})=>i(de,{value:e.value,onChange:e.onChange,realmName:n,save:z})}),i(Le,{variant:"light",children:s(Fe,{onSubmit:ce(z),isHorizontal:!0,role:"view-realm",className:"pf-u-mt-lg",children:[i(U,{label:t("name"),fieldId:"kc-client-profile-name",isRequired:!0,helperTextInvalid:c.formState.errors.name?.message,validated:c.formState.errors.name?w.error:w.default,children:i(Re,{id:"kc-client-profile-name","data-testid":"client-policy-name",validated:c.formState.errors.name?w.error:w.default,...c.register("name",{required:{value:!0,message:t("required")},validate:e=>a?.some(o=>o.name===e)?t("createClientProfileNameHelperText").toString():!0})})}),i(U,{label:t("description"),fieldId:"kc-description",children:i(Ee,{"aria-label":t("description"),id:"kc-client-policy-description","data-testid":"client-policy-description",...c.register("description")})}),s(qe,{children:[i(k,{variant:"primary",type:"submit","data-testid":"saveCreatePolicy",isDisabled:!c.formState.isValid,children:t("save")}),i(k,{id:"cancelCreatePolicy",variant:"link",onClick:()=>u||r?ge():b(S({realm:n,tab:"policies"})),"data-testid":"cancelCreatePolicy",children:t(u?"reload":"cancel")})]}),(u||c.formState.isSubmitted)&&s(y,{children:[s(Y,{children:[i(V,{children:s(I,{className:"kc-conditions",component:L.h1,children:[t("conditions"),i(x,{helpText:t("conditionsHelp"),fieldLabelId:"conditions"})]})}),i(V,{align:{default:"alignRight"},children:i(k,{id:"addCondition",component:e=>i(O,{...e,to:xe({realm:n,policyName:r})}),variant:"link",className:"kc-addCondition","data-testid":"addCondition",icon:i(W,{}),children:t("addCondition")})})]}),G.length>0?i(Z,{"aria-label":t("conditions"),isCompact:!0,children:G.map((e,o)=>i(_,{"aria-labelledby":"conditions-list-item",id:e.condition,"data-testid":"conditions-list-item",children:i(ee,{"data-testid":"conditions-list-row",children:i(ie,{dataListCells:[s(te,{"data-testid":"condition-type",children:[Object.keys(e.configuration).length!==0?i(O,{"data-testid":`${e.condition}-condition-link`,to:Ke({realm:n,conditionName:e.condition,policyName:r}),className:"kc-condition-link",children:e.condition},e.condition):e.condition,fe?.map(l=>l.id===e.condition&&s(y,{children:[i(x,{helpText:l.helpText,fieldLabelId:e.condition}),i(k,{variant:"link","aria-label":"remove-condition",isInline:!0,icon:i(oe,{className:"kc-conditionType-trash-icon","data-testid":`delete-${e.condition}-condition`,onClick:()=>{Pe(),ae({idx:o,name:l.id})}})})]}))]},`name-${o}`)]})})},`list-item-${o}`))}):s(y,{children:[i(X,{}),i(I,{className:"kc-emptyConditions",component:L.h2,children:t("emptyConditions")})]})]}),(u||c.formState.isSubmitted)&&s(y,{children:[s(Y,{children:[i(V,{children:s(I,{className:"kc-client-profiles",component:L.h1,children:[t("clientProfiles"),i(x,{helpText:t("clientProfilesHelp"),fieldLabelId:"clientProfiles"})]})}),i(V,{align:{default:"alignRight"},children:i(k,{id:"addClientProfile",variant:"link",className:"kc-addClientProfile","data-testid":"addClientProfile",icon:i(W,{}),onClick:J,children:t("addClientProfile")})})]}),D.length>0?i(Z,{"aria-label":t("profiles"),isCompact:!0,children:D.map((e,o)=>i(_,{"aria-labelledby":`${e}-profile-list-item`,id:`${e}-profile-list-item`,"data-testid":"profile-list-item",children:i(ee,{"data-testid":"profile-list-row",children:i(ie,{dataListCells:[s(te,{"data-testid":"profile-name",children:[e&&i(O,{"data-testid":"profile-name-link",to:Ve({realm:n,profileName:e}),className:"kc-profile-link",children:e},e),D.filter(l=>l===e).map(l=>s(y,{children:[i(x,{helpText:F.find(f=>l===f.name)?.description,fieldLabelId:e}),i(k,{variant:"link","aria-label":"remove-client-profile",isInline:!0,icon:i(oe,{className:"kc-conditionType-trash-icon","data-testid":"deleteClientProfileDropdown",onClick:()=>{ye(),re({idx:o,name:l})}})})]}))]},"name")]})})},e))}):s(y,{children:[i(X,{}),i(I,{className:"kc-emptyClientProfiles",component:L.h2,children:t("emptyProfiles")})]})]})]})})]})}export{vi as default};
//# sourceMappingURL=NewClientPolicyForm-hRBAupDw.js.map
